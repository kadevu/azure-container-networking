apiVersion: v1
kind: Pod
metadata:
  name: {{ .PodName }}
  namespace: {{ .Namespace }}
  labels:
    kubernetes.azure.com/pod-network-instance: {{ .PNIName }}
    kubernetes.azure.com/pod-network: {{ .PNName }}
spec:
  nodeSelector:
    kubernetes.io/hostname: {{ .NodeName }}
  containers:
  - name: net-debugger
    image: {{ .Image }}
    command: ["/bin/bash", "-c"]
    args:
      - |
        echo "Pod Network Diagnostics started on $(hostname)"
        echo "Pod IP: $(hostname -i)"
        echo "Starting TCP listener on port 8080"
        
        # Start netcat listener that responds to connections
        while true; do 
          echo "TCP Connection Success from $(hostname) at $(date)" | nc -l -p 8080
        done
    ports:
    - containerPort: 8080
      protocol: TCP
    resources:
      limits:
        cpu: 300m
        memory: 600Mi
      requests:
        cpu: 300m
        memory: 600Mi
    securityContext:
      privileged: true
  restartPolicy: Always
