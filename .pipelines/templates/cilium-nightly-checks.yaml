steps:
  - script: |
      set -e
      echo "validate pod IP assignment and check systemd-networkd restart"
      kubectl get pod -owide -A

      ciliumNamespace=`kubectl get ns | grep cilium-test | awk '{print $1}'`
      echo "Check cilium identities in ${ciliumNamespace} namepsace during nightly run"
      echo "expect the identities to be deleted when the namespace is deleted"
      kubectl get ciliumidentity | grep cilium-test

      make test-validate-state

      echo "delete cilium connectivity test resources and re-validate state"
      for namespace in ${ciliumNamespace}; do
        kubectl delete ns ${namespace}
      done
      kubectl get pod -owide -A

      make test-validate-state
    name: "validatePods"
    displayName: "Validate Pods"
  - script: |
      ciliumNamespace=`kubectl get ns | grep cilium-test | awk '{print $1}'`
      kubectl get pod -Aowide | grep cilium-test

      for namespace in ${ciliumNamespace}; do
        echo "Checking namespace: $namespace"
        echo "wait for pod and cilium identity deletion in ${namespace} namespace"
        while true; do
          pods=$(kubectl get pods -n ${namespace} --no-headers=true 2>/dev/null)
          if [[ -z "$pods" ]]; then
            echo "No pods found"
              break
          fi
          sleep 2s
        done
        sleep 20s
        echo "Verify cilium identities are deleted from ${namespace}"
        checkIdentity="$(kubectl get ciliumidentity -o json | grep cilium-test | jq -e 'length == 0')"
        if [[ -n $checkIdentity ]]; then
          echo "##[error]Cilium Identities still present in ${namespace} namespace"
          exit 1
        else
          printf -- "Identities deleted from ${namespace} namespace\n"
        fi
      done

    name: "CiliumIdentities"
    displayName: "Verify Cilium Identities Deletion"
